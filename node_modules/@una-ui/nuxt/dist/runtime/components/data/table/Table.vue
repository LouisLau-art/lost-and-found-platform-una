<script setup>
import {
  FlexRender,
  getCoreRowModel,
  getExpandedRowModel,
  getFilteredRowModel,
  getPaginationRowModel,
  getSortedRowModel,
  useVueTable
} from "@tanstack/vue-table";
import { computed, h } from "vue";
import { cn, valueUpdater } from "../../../utils";
import Button from "../../elements/Button.vue";
import Checkbox from "../../forms/Checkbox.vue";
import Input from "../../forms/Input.vue";
import ScrollArea from "../../scroll-area/ScrollArea.vue";
import TableBody from "./TableBody.vue";
import TableCell from "./TableCell.vue";
import TableEmpty from "./TableEmpty.vue";
import TableFooter from "./TableFooter.vue";
import TableHead from "./TableHead.vue";
import TableHeader from "./TableHeader.vue";
import TableLoading from "./TableLoading.vue";
import TableRow from "./TableRow.vue";
const props = defineProps({
  class: { type: null, required: false },
  state: { type: Object, required: false },
  onStateChange: { type: Function, required: false },
  renderFallbackValue: { type: null, required: false },
  data: { type: Array, required: true },
  columns: { type: Array, required: true },
  rowId: { type: String, required: false },
  autoResetAll: { type: Boolean, required: false },
  enableRowSelection: { type: Boolean, required: false },
  enableMultiRowSelection: { type: Boolean, required: false, default: true },
  enableSubRowSelection: { type: Boolean, required: false },
  enableColumnFilters: { type: Boolean, required: false },
  manualFiltering: { type: Boolean, required: false },
  enableSorting: { type: Boolean, required: false },
  enableMultiSort: { type: Boolean, required: false },
  enableMultiRemove: { type: Boolean, required: false },
  enableSortingRemoval: { type: Boolean, required: false, default: true },
  manualSorting: { type: Boolean, required: false },
  maxMultiSortColCount: { type: Number, required: false },
  manualPagination: { type: Boolean, required: false },
  pageCount: { type: Number, required: false },
  rowCount: { type: Number, required: false },
  autoResetPageIndex: { type: Boolean, required: false },
  sortingFns: { type: Object, required: false },
  sortDescFirst: { type: Boolean, required: false },
  isMultiSortEvent: { type: Function, required: false },
  _tableHead: { type: Object, required: false },
  _tableHeader: { type: Object, required: false },
  _tableFooter: { type: Object, required: false },
  _tableBody: { type: Object, required: false },
  _tableCaption: { type: Object, required: false },
  _tableRow: { type: [Object, Function], required: false },
  _tableCell: { type: Object, required: false },
  _tableEmpty: { type: Object, required: false },
  _tableLoading: { type: Object, required: false },
  _scrollArea: { type: Object, required: false },
  loading: { type: Boolean, required: false },
  una: { type: Object, required: false },
  _features: { type: Array, required: false },
  debugAll: { type: Boolean, required: false },
  debugCells: { type: Boolean, required: false },
  debugColumns: { type: Boolean, required: false },
  debugHeaders: { type: Boolean, required: false },
  debugRows: { type: Boolean, required: false },
  debugTable: { type: Boolean, required: false },
  defaultColumn: { type: Object, required: false },
  getRowId: { type: Function, required: false },
  getSubRows: { type: Function, required: false },
  initialState: { type: Object, required: false },
  mergeOptions: { type: Function, required: false },
  meta: { type: Object, required: false },
  emptyText: { type: String, required: false },
  emptyIcon: { type: String, required: false }
});
const emit = defineEmits(["select", "selectAll", "expand", "row"]);
const slots = defineSlots();
const rowSelection = defineModel("rowSelection", { type: Object });
const sorting = defineModel("sorting", { type: Array });
const columnVisibility = defineModel("columnVisibility", { type: Object });
const columnFilters = defineModel("columnFilters", { type: Array });
const globalFilter = defineModel("globalFilter", { type: String });
const columnOrder = defineModel("columnOrder", { type: Array });
const columnPinning = defineModel("columnPinning", { type: Object });
const expanded = defineModel("expanded", { type: [Boolean, Object] });
const grouping = defineModel("grouping", { type: Array });
const pagination = defineModel("pagination", { type: Object, ...{
  default: () => ({
    pageIndex: 0,
    pageSize: 10
  })
} });
const columnsWithMisc = computed(() => {
  let data = [];
  data = props.enableRowSelection ? [
    {
      accessorKey: "selection",
      header: props.enableMultiRowSelection ? ({ table: table2 }) => h(Checkbox, {
        "modelValue": table2.getIsAllPageRowsSelected() || table2.getIsSomePageRowsSelected() && "indeterminate",
        "onUpdate:modelValue": (value) => {
          table2.toggleAllPageRowsSelected(!!value);
          emit("selectAll", table2.getRowModel().rows.map((row) => row.original));
        },
        "areaLabel": "Select all rows",
        "onClick": (event) => {
          event.stopPropagation();
        }
      }) : "",
      cell: ({ row }) => h(Checkbox, {
        "modelValue": row.getIsSelected() ?? false,
        "onUpdate:modelValue": (value) => {
          row.toggleSelected(!!value);
          emit("select", row.original);
        },
        "areaLabel": "Select row",
        "onClick": (event) => {
          event.stopPropagation();
        }
      }),
      enableSorting: false
    },
    ...props.columns
  ] : props.columns;
  data = slots.expanded ? [
    {
      accessorKey: "expanded",
      header: "",
      cell: ({ row }) => h(Button, {
        size: "xs",
        icon: true,
        square: true,
        btn: "ghost-gray",
        label: "i-radix-icons-chevron-down",
        onClick: () => {
          row.toggleExpanded();
          emit("expand", row);
        },
        una: {
          btnIconLabel: cn(
            "transform transition-transform duration-200",
            row.getIsExpanded() ? "-rotate-180" : "rotate-0"
          )
        }
      }),
      enableSorting: false,
      enableHiding: false
    },
    ...data
  ] : data;
  return data;
});
const table = useVueTable({
  get data() {
    return props.data ?? [];
  },
  get columns() {
    return columnsWithMisc.value ?? [];
  },
  state: {
    get sorting() {
      return sorting.value;
    },
    get columnFilters() {
      return columnFilters.value;
    },
    get globalFilter() {
      return globalFilter.value;
    },
    get rowSelection() {
      return rowSelection.value;
    },
    get columnVisibility() {
      return columnVisibility.value;
    },
    get pagination() {
      return pagination.value;
    },
    get columnOrder() {
      return columnOrder.value;
    },
    get columnPinning() {
      return columnPinning.value;
    },
    get expanded() {
      return expanded.value;
    },
    get grouping() {
      return grouping.value;
    }
  },
  enableMultiRowSelection: props.enableMultiRowSelection,
  enableSubRowSelection: props.enableSubRowSelection,
  autoResetAll: props.autoResetAll,
  enableRowSelection: props.enableRowSelection,
  enableColumnFilters: props.enableColumnFilters,
  manualPagination: props.manualPagination,
  manualSorting: props.manualSorting,
  manualFiltering: props.manualFiltering,
  pageCount: props.pageCount,
  rowCount: props.rowCount,
  autoResetPageIndex: props.autoResetPageIndex,
  enableSorting: props.enableSorting,
  enableSortingRemoval: props.enableSortingRemoval,
  enableMultiSort: props.enableMultiSort,
  enableMultiRemove: props.enableMultiRemove,
  maxMultiSortColCount: props.maxMultiSortColCount,
  sortingFns: props.sortingFns,
  isMultiSortEvent: props.isMultiSortEvent,
  getCoreRowModel: getCoreRowModel(),
  getSortedRowModel: getSortedRowModel(),
  getFilteredRowModel: getFilteredRowModel(),
  getPaginationRowModel: getPaginationRowModel(),
  getRowId: (row) => props.rowId ? row[props.rowId] : row.id,
  getSubRows: (row) => row.subRows,
  getExpandedRowModel: getExpandedRowModel(),
  onSortingChange: (updaterOrValue) => valueUpdater(updaterOrValue, sorting),
  onRowSelectionChange: (updaterOrValue) => valueUpdater(updaterOrValue, rowSelection),
  onColumnVisibilityChange: (updaterOrValue) => valueUpdater(updaterOrValue, columnVisibility),
  onColumnFiltersChange: (updaterOrValue) => valueUpdater(updaterOrValue, columnFilters),
  onGlobalFilterChange: (updaterOrValue) => valueUpdater(updaterOrValue, globalFilter),
  onPaginationChange: (updaterOrValue) => valueUpdater(updaterOrValue, pagination),
  onColumnOrderChange: (updaterOrValue) => valueUpdater(updaterOrValue, columnOrder),
  onColumnPinningChange: (updaterOrValue) => valueUpdater(updaterOrValue, columnPinning),
  onExpandedChange: (updaterOrValue) => valueUpdater(updaterOrValue, expanded),
  onGroupingChange: (updaterOrValue) => valueUpdater(updaterOrValue, grouping)
});
function getHeaderColumnFiltersCount(headers) {
  let count = 0;
  headers.forEach((header) => {
    if (header.column.columnDef.enableColumnFilter)
      count++;
  });
  return count;
}
function getRowAttrs(data) {
  if (typeof props._tableRow === "function") {
    return props._tableRow(data);
  }
  return props._tableRow;
}
defineExpose({
  ...table
});
</script>

<template>
  <div
    :class="cn('table-root', props.una?.tableRoot)"
  >
    <ScrollArea
      orientation="horizontal"
      v-bind="props._scrollArea"
      :una
    >
      <table
        v-bind="$attrs"
        :class="cn(
  'table',
  props.una?.table,
  props.class
)"
      >
        <!-- header -->
        <TableHeader
          :una
          v-bind="props._tableHeader"
        >
          <slot name="header" :table="table">
            <TableRow
              v-for="headerGroup in table.getHeaderGroups()"
              :key="headerGroup.id"
              :una
              v-bind="getRowAttrs()"
            >
              <!-- headers -->
              <TableHead
                v-for="header in headerGroup.headers"
                :key="header.id"
                :colspan="header.colSpan"
                :data-pinned="header.column.getIsPinned()"
                :una
                v-bind="{ ...props._tableHead, ...header.column.columnDef.meta }"
              >
                <Button
                  v-if="header.column.columnDef.enableSorting || header.column.columnDef.enableSorting !== false && enableSorting"
                  btn="ghost-gray"
                  size="sm"
                  class="font-normal -ml-1em"
                  :una="{
  btnTrailing: 'text-sm'
}"
                  :trailing="header.column.getIsSorted() === 'asc' ? 'i-lucide-arrow-up-wide-narrow' : header.column.getIsSorted() === 'desc' ? 'i-lucide-arrow-down-narrow-wide' : 'i-lucide-arrow-up-down'"
                  @click="header.column.getToggleSortingHandler()?.($event)"
                >
                  <slot
                    :name="`${header.id}-header`"
                    :column="header.column"
                  >
                    <FlexRender
                      v-if="!header.isPlaceholder"
                      :render="header.column.columnDef.header"
                      :props="header.getContext()"
                    />
                  </slot>
                </Button>

                <slot
                  v-else
                  :name="`${header.id}-header`"
                  :column="header.column"
                >
                  <FlexRender
                    v-if="!header.isPlaceholder"
                    :render="header.column.columnDef.header"
                    :props="header.getContext()"
                  />
                </slot>
              </TableHead>
            </TableRow>

            <!-- column filters -->
            <template
              v-for="headerGroup in table.getHeaderGroups()"
              :key="headerGroup.id"
            >
              <TableRow
                v-if="getHeaderColumnFiltersCount(headerGroup.headers) > 0 || enableColumnFilters"
                data-filter="true"
                :una
                v-bind="getRowAttrs()"
              >
                <TableHead
                  v-for="header in headerGroup.headers"
                  :key="header.id"
                  :una
                  :colspan="header.colSpan"
                  class="font-normal"
                  :data-pinned="header.column.getIsPinned()"
                  v-bind="{ ...props._tableHead, ...header.column.columnDef.meta }"
                >
                  <slot
                    v-if="header.id !== 'selection' && (header.column.columnDef.enableColumnFilter !== false && enableColumnFilters || header.column.columnDef.enableColumnFilter)"
                    :name="`${header.id}-filter`"
                    :column="header.column"
                  >
                    <Input
                      class="w-auto"
                      :model-value="header.column.getFilterValue()"
                      :placeholder="header.column.columnDef.header"
                      @update:model-value="header.column.setFilterValue($event)"
                    />
                  </slot>
                </TableHead>
              </TableRow>
            </template>
          </slot>

          <TableLoading
            :enabled="props.loading"
            :una
            v-bind="props._tableLoading"
          >
            <slot name="loading" />
          </TableLoading>
        </TableHeader>

        <!-- body -->
        <TableBody
          :una
          v-bind="props._tableBody"
        >
          <slot name="body" :table="table">
            <template v-if="table.getRowModel().rows?.length">
              <template
                v-for="row in table.getRowModel().rows"
                :key="row.id"
              >
                <TableRow
                  :data-state="row.getIsSelected() && 'selected'"
                  :una
                  v-bind="getRowAttrs(row.original)"
                  @click="emit('row', $event, row.original)"
                >
                  <slot
                    name="row"
                    :row="row"
                  >
                    <!-- rows -->
                    <TableCell
                      v-for="cell in row.getVisibleCells()"
                      :key="cell.id"
                      :data-pinned="cell.column.getIsPinned()"
                      :una
                      v-bind="{ ...props._tableCell, ...cell.column.columnDef.meta }"
                    >
                      <slot
                        :name="`${cell.column.id}-cell`"
                        :cell="cell"
                      >
                        <FlexRender
                          :render="cell.column.columnDef.cell"
                          :props="cell.getContext()"
                        />
                      </slot>
                    </TableCell>
                  </slot>
                </TableRow>

                <!-- expanded -->
                <TableRow
                  v-if="row.getIsExpanded() && $slots.expanded"
                  :una
                  v-bind="getRowAttrs(row.original)"
                >
                  <TableCell
                    :colspan="row.getAllCells().length"
                    :una
                    v-bind="props._tableCell"
                  >
                    <slot name="expanded" :row="row" />
                  </TableCell>
                </TableRow>
              </template>
            </template>

            <TableEmpty
              v-else
              :colspan="table.getAllLeafColumns().length"
              :una
              :empty-text="props.emptyText"
              :empty-icon="props.emptyIcon"
              v-bind="props._tableEmpty"
            >
              <slot name="empty" />
            </TableEmpty>
          </slot>
        </TableBody>

        <!-- footer -->
        <TableFooter
          v-if="table.getFooterGroups().length > 0"
          :una
          v-bind="props._tableFooter"
        >
          <slot name="footer" :table="table">
            <template
              v-for="footerGroup in table.getFooterGroups()"
              :key="footerGroup.id"
            >
              <TableRow
                v-if="footerGroup.headers.length > 0"
                :una
                v-bind="getRowAttrs()"
              >
                <template
                  v-for="header in footerGroup.headers"
                  :key="header.id"
                >
                  <TableHead
                    v-if="header.column.columnDef.footer"
                    :colspan="header.colSpan"
                    :una
                    v-bind="{ ...props._tableHead, ...header.column.columnDef.meta }"
                  >
                    <slot :name="`${header.id}-footer`" :column="header.column">
                      <FlexRender
                        v-if="!header.isPlaceholder"
                        :render="header.column.columnDef.footer"
                        :props="header.getContext()"
                      />
                    </slot>
                  </TableHead>
                </template>
              </TableRow>
            </template>
          </slot>
        </TableFooter>
      </table>
    </ScrollArea>
  </div>
</template>
