<script>
import { computed } from "vue";
</script>

<script setup>
import { SelectRoot, useForwardPropsEmits } from "reka-ui";
import { cn } from "../../../utils";
import SelectContent from "./SelectContent.vue";
import SelectGroup from "./SelectGroup.vue";
import SelectItem from "./SelectItem.vue";
import SelectLabel from "./SelectLabel.vue";
import SelectSeparator from "./SelectSeparator.vue";
import SelectTrigger from "./SelectTrigger.vue";
import SelectValue from "./SelectValue.vue";
const props = defineProps({
  items: { type: null, required: false },
  itemKey: { type: null, required: false },
  valueKey: { type: null, required: false },
  label: { type: String, required: false },
  groupSeparator: { type: Boolean, required: false },
  defaultValue: { type: null, required: false },
  modelValue: { type: null, required: false },
  multiple: { type: null, required: false },
  _selectScrollUpButton: { type: Object, required: false },
  _selectItemText: { type: Object, required: false },
  _selectScrollDownButton: { type: Object, required: false },
  _selectGroup: { type: Object, required: false },
  _selectSeparator: { type: Object, required: false },
  _selectContent: { type: Object, required: false },
  _selectValue: { type: Object, required: false },
  _selectTrigger: { type: Object, required: false },
  _selectItem: { type: Object, required: false },
  _selectLabel: { type: Object, required: false },
  una: { type: Object, required: false },
  open: { type: Boolean, required: false },
  defaultOpen: { type: Boolean, required: false },
  by: { type: [String, Function], required: false },
  dir: { type: String, required: false },
  autocomplete: { type: String, required: false },
  disabled: { type: Boolean, required: false },
  name: { type: String, required: false },
  required: { type: Boolean, required: false },
  class: { type: null, required: false },
  size: { type: null, required: false, default: "sm" },
  placeholder: { type: String, required: false },
  selectItem: { type: null, required: false },
  status: { type: String, required: false },
  select: { type: String, required: false },
  id: { type: String, required: false }
});
const emits = defineEmits(["update:modelValue", "update:open"]);
const hasGroups = computed(() => {
  return Array.isArray(props.items) && props.items.length > 0 && typeof props.items[0] === "object" && "items" in props.items[0];
});
const forwarded = useForwardPropsEmits(props, emits);
function formatSelectedValue(value) {
  if (!value || Array.isArray(value) && value.length === 0)
    return null;
  if (props.multiple && Array.isArray(value)) {
    return value.map((val) => {
      if (props.valueKey && typeof val === "object") {
        return val[props.valueKey];
      }
      return val;
    }).join(", ");
  }
  if (props.valueKey && typeof value === "object") {
    return value[props.valueKey];
  }
  return value;
}
</script>

<template>
  <SelectRoot
    :class="cn(
  props.una?.select,
  props.class
)"
    v-bind="forwarded"
  >
    <slot :model-value :open>
      <slot name="trigger-wrapper" :model-value :open>
        <SelectTrigger
          :id
          :size
          :status
          :select
          v-bind="props._selectTrigger"
          :una
        >
          <slot name="trigger" :model-value :open="open">
            <SelectValue
              :placeholder="props.placeholder"
              v-bind="props._selectValue"
              :aria-label="formatSelectedValue(modelValue)"
              :data-status="status"
              :una
            >
              <slot name="value" :model-value :open>
                {{ formatSelectedValue(modelValue) || props.placeholder }}
              </slot>
            </SelectValue>
          </slot>
        </SelectTrigger>
      </slot>

      <SelectContent
        :size
        v-bind="{
  ..._selectContent,
  _selectScrollDownButton,
  _selectScrollUpButton
}"
        :una
      >
        <slot name="content" :items="items">
          <template v-if="!hasGroups">
            <SelectLabel
              v-if="label"
              v-bind="_selectLabel"
              :una
            >
              <slot name="label" :label>
                {{ label }}
              </slot>
            </SelectLabel>

            <template
              v-for="item in items"
              :key="item"
            >
              <SelectItem
                :value="item"
                :size
                :select-item
                v-bind="props._selectItem"
                :una
              >
                <slot name="item" :item="item">
                  {{ props.itemKey && item ? item[props.itemKey] : item }}
                </slot>
                <template #indicator>
                  <slot name="indicator" :item="item" />
                </template>
              </SelectItem>
            </template>
          </template>

          <template v-if="hasGroups">
            <SelectGroup
              v-for="(group, i) in items"
              :key="i"
              v-bind="props._selectGroup"
              :una
            >
              <SelectSeparator
                v-if="i > 0 && props.groupSeparator"
                v-bind="props._selectSeparator"
                :una
              />

              <slot name="group" :items="group">
                <SelectLabel
                  v-if="group.label"
                  :size
                  v-bind="{ ...props._selectLabel, ...group._selectLabel }"
                  :una
                >
                  <slot name="label" :label="group.label">
                    {{ group.label }}
                  </slot>
                </SelectLabel>

                <template
                  v-for="item in group.items"
                  :key="item"
                >
                  <SelectItem
                    :value="item"
                    :size
                    :select-item
                    v-bind="{ ..._selectItem, ...group._selectItem }"
                    :una
                  >
                    <slot name="item" :item="item">
                      {{ props.itemKey ? item[props.itemKey] : item }}
                    </slot>
                    <template #indicator>
                      <slot name="indicator" :item="item" />
                    </template>
                  </SelectItem>
                </template>
              </slot>
            </SelectGroup>
          </template>
        </slot>
      </SelectContent>
    </slot>
  </SelectRoot>
</template>
