<script setup>
import { reactiveOmit } from "@vueuse/core";
import { Primitive } from "reka-ui";
import { computed, h } from "vue";
import { cn, omitProps } from "../../utils";
import Avatar from "./avatar/Avatar.vue";
const props = defineProps({
  max: { type: Number, required: false },
  overflowLabel: { type: String, required: false },
  una: { type: Object, required: false },
  _avatarRoot: { type: Object, required: false },
  _avatarImage: { type: Object, required: false },
  _avatarFallback: { type: Object, required: false },
  class: { type: null, required: false },
  size: { type: null, required: false },
  square: { type: null, required: false },
  rounded: { type: null, required: false },
  avatar: { type: null, required: false },
  asChild: { type: Boolean, required: false },
  as: { type: null, required: false, default: "div" },
  icon: { type: Boolean, required: false },
  delayMs: { type: Number, required: false },
  referrerPolicy: { type: null, required: false },
  crossOrigin: { type: null, required: false }
});
const slots = defineSlots();
const max = computed(() => typeof props.max === "string" ? Number.parseInt(props.max, 10) : props.max);
const children = computed(() => {
  let children2 = slots.default?.();
  if (children2?.length) {
    children2 = children2.flatMap((child) => {
      if (typeof child.type === "symbol") {
        if (typeof child.children === "string") {
          return null;
        }
        return child.children;
      }
      return child;
    }).filter(Boolean);
  }
  return children2 || [];
});
const maxVisibleCount = computed(() => {
  if (!max.value || max.value <= 0) {
    return children.value.length;
  }
  return Math.min(max.value, children.value.length);
});
const hiddenCount = computed(() => {
  if (!children.value.length) {
    return 0;
  }
  return Math.max(0, children.value.length - maxVisibleCount.value);
});
const visibleAvatars = computed(() => {
  if (!children.value.length) {
    return [];
  }
  return [...children.value].slice(0, maxVisibleCount.value).reverse();
});
const displayAvatars = computed(() => {
  const result = [...visibleAvatars.value];
  if (hiddenCount.value > 0 || props.overflowLabel) {
    const avatarProps = children.value.length > 0 ? omitProps(children.value[0].props || {}, ["src", "alt", "label", "icon"]) : {};
    result.unshift(
      h(Avatar, {
        label: props.overflowLabel || `+${hiddenCount.value}`,
        class: cn(
          props.una?.avatarGroupCount
        ),
        una: {
          avatarFallback: cn(
            "avatar-group-count",
            props.una?.avatarGroupCount,
            avatarProps.una?.avatarFallback
          ),
          ...avatarProps.una
        },
        ...avatarProps
      })
    );
  }
  return result;
});
const rootProps = reactiveOmit(props, ["max", "as", "asChild", "overflowLabel"]);
</script>

<template>
  <Primitive
    :as
    :size
    :class="cn(
  'avatar-group',
  una?.avatarGroup
)"
    :as-child
  >
    <component
      :is="avatar"
      v-for="(avatar, count) in displayAvatars"
      v-bind="{ ...rootProps, ...avatar.props }"
      :key="count"
      :class="cn(
  'avatar-group-item',
  props.class
)"
    />
  </Primitive>
</template>
